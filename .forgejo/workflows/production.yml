name: Deploy To Production

on:
  push:
    tags:
      - '*'

jobs:
  build:
    environment: prod

    runs-on: node

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
    - run: yarn install --frozen-lockfile
    - run: yarn build
    - run: yarn test

    - name: "Copy files over to location"
      run: rsync -rvzP --delete . ${{ secrets.PROD_REPO_PATH }}

  deploy:
    environment: prod
    needs: build
    runs-on: node
    steps:
    - uses: https://github.com/appleboy/ssh-action@v1.1.0
      env:
        ABOUT_FUNDING: ${{ vars.PROD_ABOUT_FUNDING }}
        ABOUT_REPO: ${{ vars.PROD_ABOUT_REPO }}
        BOT_AUTHOR: ${{ vars.PROD_BOT_AUTHOR }}
        BOT_CLIENTID: ${{ vars.PROD_BOT_CLIENTID }}
        BOT_OWNERID: ${{ vars.PROD_BOT_OWNERID }}
        BOT_TOKEN: ${{ secrets.PROD_BOT_TOKEN }}
        BOT_VER: ${{ github.REF_NAME }}
        CACHE_INTERVAL: ${{ vars.PROD_CACHE_INTERVAL }}
        DATA_DIR: ${{ secrets.PROD_DATA_DIR }}
        DB_AUTH_PASS: ${{ secrets.PROD_DB_AUTH_PASS }}
        DB_AUTH_USER: ${{ secrets.PROD_DB_AUTH_USER }}
        DB_DATA_LOCATION: ${{ secrets.PROD_DB_DATA_LOCATION }}
        DB_HOST: ${{ secrets.PROD_DB_HOST }}
        DB_LOGGING: ${{ secrets.PROD_DB_LOGGING }}
        DB_NAME: ${{ secrets.PROD_DB_NAME }}
        DB_PORT: ${{ secrets.PROD_DB_PORT }}
        DB_ROOT_HOST: ${{ secrets.PROD_DB_ROOT_HOST }}
        DB_SYNC: ${{ secrets.PROD_DB_SYNC }}
        SERVER_PATH: ${{ secrets.PROD_SSH_SERVER_PATH }}
      with:
        host: ${{ secrets.PROD_SSH_HOST }}
        username: ${{ secrets.PROD_SSH_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: ${{ secrets.PROD_SSH_PORT }}
        envs: ABOUT_FUNDING,ABOUT_REPO,BOT_AUTHOR,BOT_CLIENTID,BOT_OWNERID,BOT_TOKEN,BOT_VER,CACHE_INTERVAL,DB_AUTH_PASS,DB_AUTH_USER,DB_DATA_LOCATION,DB_HOST,DB_LOGGING,DB_NAME,DB_PORT,DB_ROOT_HOST,DB_SYNC,SERVER_PATH
        script: |
          source .sshrc \
          && cd /home/vylpes/apps/vylbot/vylbot_prod \
          && docker compose down \
          && (pm2 stop vylbot_prod || true) \
          && (pm2 delete vylbot_prod || true) \
          && docker compose up -d \
          && sleep 10 \
          && yarn db:up \
          && pm2 start --name vylbot_prod dist/vylbot.js
